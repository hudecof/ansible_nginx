---
- name: "check nginx directories"
  action: file path={{ item.name }} owner={{ item.owner }} group={{ item.group }} mode={{ item.mode }} state=directory
  with_items:
    - { name: "{{ nginx_dir_etc }}", owner: "root", group: "root", mode: "0750" }
    - { name: "{{ nginx_dir_etc }}/conf.d", owner: "root", group: "root", mode: "0750" }
    - { name: "{{ nginx_dir_etc }}/sites-available", owner: "root", group: "root", mode: "0750" }
    - { name: "{{ nginx_dir_etc }}/sites-enabled", owner: "root", group: "root", mode: "0750" }
    - { name: "{{ nginx_dir_etc }}/modules", owner: "root", group: "root", mode: "0750" }
    - { name: "{{ nginx_dir_log }}", owner: "root", group: "root", mode: "0750" }
  tags:
    - nginx
    - setup

- name: "creating extra directories"
  action: file path={{ nginx_dir_etc}}/{{ item.name }} owner={{ item.owner }} group={{ item.group }} mode={{ item.mode }} state=directory
  with_items: $nginx_dir_extra
  tags:
    - nginx
    - setup

- name: "tweaking sysctl"
  action: sysctl name={{ item.name }} value={{ item.value }} reload=yes state=present
  tags:
    - nginx
    - setup
  with_items:
    - { name: 'net.ipv6.bindv6only', value: '1' }
    - { name: 'net.ipv4.ip_forward', value: '0' }
    - { name: 'net.ipv6.conf.all.forwarding', value: '0' }
    - { name: 'net.ipv4.icmp_echo_ignore_broadcasts', value: '1' }
    - { name: 'net.ipv4.icmp_ignore_bogus_error_responses', value: '1' }
    - { name: 'net.ipv4.tcp_syncookies', value: '1' }
    - { name: 'net.ipv4.conf.all.accept_source_route', value: '1' }
    - { name: 'net.ipv4.conf.default.accept_source_route', value: '0' }
    - { name: 'net.ipv4.conf.all.rp_filter', value: '1' }
    - { name: 'net.ipv4.conf.default.rp_filter', value: '1' }
    - { name: 'net.ipv4.conf.all.accept_redirects', value: '0' }
    - { name: 'net.ipv4.conf.default.accept_redirects', value: '0' }
    - { name: 'net.ipv4.conf.all.secure_redirects', value: '0' }
    - { name: 'net.ipv4.conf.default.secure_redirects', value: '0' }
    - { name: 'net.ipv4.conf.all.send_redirects', value: '0' }
    - { name: 'net.ipv4.conf.default.send_redirects', value: '0' }
    - { name: 'kernel.randomize_va_space', value: '1' }
    - { name: 'net.ipv6.conf.default.router_solicitations', value: '0' }
    - { name: 'net.ipv6.conf.default.accept_ra_rtr_pref', value: '0' }
    - { name: 'net.ipv6.conf.default.accept_ra_pinfo', value: '0' }
    - { name: 'net.ipv6.conf.default.accept_ra_defrtr', value: '0' }
    - { name: 'net.ipv6.conf.default.autoconf', value: '0' }
    - { name: 'net.ipv6.conf.default.dad_transmits', value: '0' }
    - { name: 'net.ipv6.conf.default.max_addresses', value: '1' }
    - { name: 'fs.file-max', value: '65535' }
